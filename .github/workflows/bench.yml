name: Benchmarks

on:
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

permissions:
  pull-requests: write

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    continue-on-error: true
    steps:
      - name: Checkout PR
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run benchmarks (PR)
        continue-on-error: true
        run: cargo bench 2>&1 | tee pr-bench.txt || true

      - name: Checkout base branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          clean: false

      - name: Run benchmarks (base)
        continue-on-error: true
        run: cargo bench 2>&1 | tee base-bench.txt || true

      - name: Compare benchmarks
        id: compare
        continue-on-error: true
        run: |
          # Keep benchmark comment under GitHub's 65,536-character limit.
          tail -n 300 base-bench.txt > base-bench-tail.txt || true
          tail -n 300 pr-bench.txt > pr-bench-tail.txt || true
          echo "## Benchmark Results" > bench-comment.md
          echo "" >> bench-comment.md
          echo "<details><summary>Base branch</summary>" >> bench-comment.md
          echo "" >> bench-comment.md
          echo '```' >> bench-comment.md
          cat base-bench-tail.txt >> bench-comment.md
          echo '```' >> bench-comment.md
          echo "</details>" >> bench-comment.md
          echo "" >> bench-comment.md
          echo "<details><summary>PR branch</summary>" >> bench-comment.md
          echo "" >> bench-comment.md
          echo '```' >> bench-comment.md
          cat pr-bench-tail.txt >> bench-comment.md
          echo '```' >> bench-comment.md
          echo "</details>" >> bench-comment.md

      - name: Post benchmark results
        continue-on-error: true
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: bench-comment.md
          header: benchmarks
